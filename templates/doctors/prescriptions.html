{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Create Prescription - E-Hospitality{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-prescription"></i> Create New Prescription
                </h3>
            </div>
            <div class="card-body">
                <!-- Patient Information -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Patient Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> {{ patient.user.first_name }} {{ patient.user.last_name }}</p>
                                <p><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
                                <p><strong>Age:</strong> 
                                    {% if patient.user.date_of_birth %}
                                        {{ patient.user.date_of_birth|age_from_birth }}
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Blood Group:</strong> {{ patient.blood_group|default:"Not specified" }}</p>
                                <p><strong>Allergies:</strong> 
                                    <span class="{% if patient.allergies %}text-danger{% else %}text-muted{% endif %}">
                                        {{ patient.allergies|default:"None reported" }}
                                    </span>
                                </p>
                                <p><strong>Emergency Contact:</strong> {{ patient.emergency_contact|default:"Not provided" }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prescription Form -->
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Left Column - Medications -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-pills"></i> Medications</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="medications" class="form-label">
                                            <i class="fas fa-prescription-bottle"></i> Prescribed Medications *
                                        </label>
                                        <textarea class="form-control" 
                                                  id="medications" 
                                                  name="medications" 
                                                  rows="8" 
                                                  placeholder="List medications with generic/brand names..." 
                                                  required></textarea>
                                        <div class="form-text">
                                            Enter each medication on a new line. Include generic and brand names if applicable.
                                        </div>
                                    </div>
                                    
                                    <!-- Quick Medication Templates -->
                                    <div class="mb-3">
                                        <label class="form-label">Quick Add Common Medications:</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary medication-button" 
                                                    onclick="addMedication('Paracetamol 500mg')">Paracetamol</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary medication-button" 
                                                    onclick="addMedication('Ibuprofen 400mg')">Ibuprofen</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary medication-button" 
                                                    onclick="addMedication('Amoxicillin 500mg')">Amoxicillin</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary medication-button" 
                                                    onclick="addMedication('Omeprazole 20mg')">Omeprazole</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Dosage & Instructions -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-clock"></i> Dosage & Instructions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="dosage" class="form-label">
                                            <i class="fas fa-calculator"></i> Dosage Information *
                                        </label>
                                        <textarea class="form-control" 
                                                  id="dosage" 
                                                  name="dosage" 
                                                  rows="4" 
                                                  placeholder="Specify dosage for each medication..." 
                                                  required></textarea>
                                        <div class="form-text">
                                            Include frequency, timing, and duration for each medication.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="instructions" class="form-label">
                                            <i class="fas fa-info-circle"></i> Additional Instructions *
                                        </label>
                                        <textarea class="form-control" 
                                                  id="instructions" 
                                                  name="instructions" 
                                                  rows="6" 
                                                  placeholder="Special instructions, precautions, follow-up notes..." 
                                                  required></textarea>
                                        <div class="form-text">
                                            Include any special precautions, dietary restrictions, or follow-up instructions.
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="diagnosis" class="form-label">
                                            <i class="fas fa-stethoscope"></i> Diagnosis (Optional)
                                        </label>
                                        <textarea class="form-control" 
                                                  id="diagnosis" 
                                                  name="diagnosis" 
                                                  rows="3" 
                                                  placeholder="Patient's condition/diagnosis..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prescription Templates -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-file-medical"></i> Common Prescription Templates</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <button type="button" class="btn btn-outline-info w-100 template-button" 
                                            onclick="loadTemplate('cold_flu')">
                                        <i class="fas fa-snowflake"></i> Cold & Flu
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button type="button" class="btn btn-outline-info w-100 template-button" 
                                            onclick="loadTemplate('hypertension')">
                                        <i class="fas fa-heartbeat"></i> Hypertension
                                    </button>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button type="button" class="btn btn-outline-info w-100 template-button" 
                                            onclick="loadTemplate('diabetes')">
                                        <i class="fas fa-tint"></i> Diabetes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Drug Interaction Checker -->
                    <div class="alert alert-warning mt-4">
                        <h6><i class="fas fa-exclamation-triangle"></i> Important Reminders</h6>
                        <ul class="mb-0">
                            <li>Always check for drug interactions before prescribing</li>
                            <li>Consider patient's allergies and medical history</li>
                            <li>Provide clear dosage instructions and duration</li>
                            <li>Include any necessary follow-up instructions</li>
                        </ul>
                    </div>

                    <!-- Action Buttons -->
<!-- Replace the problematic section with this: -->
<div class="d-flex justify-content-between mt-4">
    <div>
        {% if patient and patient.id %}
            <a href="{% url 'doctors:patient_detail' patient.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Patient
            </a>
        {% else %}
            <a href="{% url 'doctors:dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        {% endif %}
    </div>
    <div>
        <button type="button" class="btn btn-outline-primary me-2" onclick="previewPrescription()">
            <i class="fas fa-eye"></i> Preview
        </button>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Create Prescription
        </button>
    </div>
</div>

                </form>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-eye"></i> Prescription Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="prescriptionPreview" class="prescription-format">
                    <!-- Preview content will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printPrescription()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
.prescription-format {
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
    padding: 20px;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.prescription-format h3, .prescription-format h4 {
    color: #007bff;
    border-bottom: 2px solid #007bff;
    padding-bottom: 5px;
    margin-bottom: 15px;
}

.prescription-format pre {
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 3px;
    padding: 10px;
    margin-bottom: 15px;
}

.medication-button {
    transition: all 0.2s ease;
}

.medication-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.template-button {
    transition: all 0.2s ease;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.template-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.alert-warning {
    border-left: 4px solid #ffc107;
    background-color: #fff3cd;
}

.card-header.bg-primary {
    background-color: #007bff !important;
}

.border-primary {
    border-color: #007bff !important;
}

.gap-2 > * {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

@media print {
    .prescription-format {
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background-color: #fff;
        border: none;
    }
    
    .prescription-format h3, .prescription-format h4 {
        color: #000;
        border-bottom: 1px solid #000;
    }
    
    .prescription-format pre {
        background-color: #fff;
        border: 1px solid #000;
        font-size: 11pt;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Add medication to the medications textarea
function addMedication(medicationText) {
    const medicationsTextarea = document.getElementById('medications');
    const currentValue = medicationsTextarea.value;
    
    if (currentValue && !currentValue.endsWith('\n')) {
        medicationsTextarea.value += '\n';
    }
    
    medicationsTextarea.value += medicationText + '\n';
    medicationsTextarea.focus();
    
    // Visual feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Added';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 1000);
}

// Load prescription templates
function loadTemplate(templateType) {
    const medicationsField = document.getElementById('medications');
    const dosageField = document.getElementById('dosage');
    const instructionsField = document.getElementById('instructions');
    const diagnosisField = document.getElementById('diagnosis');
    
    switch(templateType) {
        case 'cold_flu':
            medicationsField.value = `Paracetamol 500mg tablets
Ibuprofen 400mg tablets
Cough syrup (Dextromethorphan)
Throat lozenges`;
            
            dosageField.value = `Paracetamol: 1-2 tablets every 6-8 hours (max 4g/day)
Ibuprofen: 1 tablet every 8 hours with food
Cough syrup: 10ml three times daily
Throat lozenges: As needed for sore throat`;
            
            instructionsField.value = `• Take plenty of rest and fluids
• Avoid cold drinks and ice cream
• Use warm salt water gargle for sore throat
• Return if symptoms worsen or fever persists beyond 3 days
• Complete the course even if feeling better`;

            diagnosisField.value = `Upper respiratory tract infection (Common cold/flu)`;
            break;
            
        case 'hypertension':
            medicationsField.value = `Amlodipine 5mg tablets
Losartan 50mg tablets
Hydrochlorothiazide 25mg tablets`;
            
            dosageField.value = `Amlodipine: 1 tablet once daily in the morning
Losartan: 1 tablet once daily
Hydrochlorothiazide: 1 tablet once daily in the morning`;
            
            instructionsField.value = `• Monitor blood pressure regularly at home
• Maintain low-salt diet (<2g sodium/day)
• Regular exercise (30 minutes daily walking)
• Avoid smoking and limit alcohol
• Follow-up in 4 weeks for BP monitoring
• Do not stop medications abruptly`;

            diagnosisField.value = `Essential hypertension`;
            break;
            
        case 'diabetes':
            medicationsField.value = `Metformin 500mg tablets
Glibenclamide 5mg tablets`;
            
            dosageField.value = `Metformin: 1 tablet twice daily with meals
Glibenclamide: 1 tablet once daily before breakfast`;
            
            instructionsField.value = `• Monitor blood glucose regularly
• Follow diabetic diet plan strictly
• Regular exercise (45 minutes daily)
• Foot care and regular eye checkups
• Carry glucose tablets for hypoglycemia
• Follow-up in 3 months with HbA1c test`;

            diagnosisField.value = `Type 2 Diabetes Mellitus`;
            break;
    }
    
    // Visual feedback for template loading
    const buttons = document.querySelectorAll('.template-button');
    buttons.forEach(btn => {
        btn.classList.remove('btn-info');
        btn.classList.add('btn-outline-info');
    });
    
    event.target.classList.remove('btn-outline-info');
    event.target.classList.add('btn-info');
    
    setTimeout(() => {
        event.target.classList.remove('btn-info');
        event.target.classList.add('btn-outline-info');
    }, 2000);
}

// Preview prescription
function previewPrescription() {
    const patientName = "{{ patient.user.first_name }} {{ patient.user.last_name }}";
    const patientId = "{{ patient.patient_id }}";
    const doctorName = "Dr. {{ user.first_name }} {{ user.last_name }}";
    const today = new Date().toLocaleDateString();
    
    const medications = document.getElementById('medications').value;
    const dosage = document.getElementById('dosage').value;
    const instructions = document.getElementById('instructions').value;
    const diagnosis = document.getElementById('diagnosis').value;
    
    if (!medications || !dosage || !instructions) {
        alert('Please fill in all required fields before previewing.');
        return;
    }
    
    const previewContent = `
        <div class="prescription-header text-center mb-4">
            <h2>E-HOSPITALITY MEDICAL CENTER</h2>
            <p class="mb-1">123 Healthcare Avenue, Medical District</p>
            <p class="mb-1">Phone: +1 (555) 123-4567 | Email: info@ehospitality.com</p>
            <hr>
        </div>
        
        <div class="prescription-info mb-4">
            <div class="row">
                <div class="col-6">
                    <strong>Patient:</strong> ${patientName}<br>
                    <strong>Patient ID:</strong> ${patientId}<br>
                    <strong>Date:</strong> ${today}
                </div>
                <div class="col-6 text-end">
                    <strong>Doctor:</strong> ${doctorName}<br>
                    <strong>License:</strong> {{ doctor.license_number|default:"MD12345" }}<br>
                    <strong>Specialization:</strong> {{ doctor.specialization|default:"General Medicine" }}
                </div>
            </div>
        </div>
        
        <div class="prescription-content">
            ${diagnosis ? `<h4><i class="fas fa-stethoscope"></i> Diagnosis</h4><pre>${diagnosis}</pre>` : ''}
            
            <h4><i class="fas fa-prescription-bottle"></i> Prescribed Medications</h4>
            <pre>${medications}</pre>
            
            <h4><i class="fas fa-clock"></i> Dosage Instructions</h4>
            <pre>${dosage}</pre>
            
            <h4><i class="fas fa-info-circle"></i> Additional Instructions</h4>
            <pre>${instructions}</pre>
        </div>
        
        <div class="prescription-footer mt-4">
            <hr>
            <div class="row">
                <div class="col-6">
                    <p class="small text-muted">Generated on: ${new Date().toLocaleString()}</p>
                </div>
                <div class="col-6 text-end">
                    <p><strong>Doctor's Signature</strong></p>
                    <p class="mt-3">_______________________</p>
                    <p class="small">${doctorName}</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('prescriptionPreview').innerHTML = previewContent;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// Print prescription
function printPrescription() {
    const printContent = document.getElementById('prescriptionPreview').innerHTML;
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Prescription - E-Hospitality</title>
            <style>
                body { 
                    font-family: 'Times New Roman', serif; 
                    line-height: 1.6; 
                    margin: 20px;
                    color: #000;
                }
                .prescription-header h2 { 
                    color: #007bff; 
                    margin-bottom: 10px; 
                }
                .prescription-header hr { 
                    border: 1px solid #007bff; 
                }
                h4 { 
                    color: #007bff; 
                    border-bottom: 1px solid #007bff; 
                    padding-bottom: 5px; 
                }
                pre { 
                    font-family: 'Times New Roman', serif; 
                    font-size: 12pt; 
                    white-space: pre-wrap; 
                    background-color: #f8f9fa;
                    border: 1px solid #ddd;
                    padding: 10px;
                    border-radius: 3px;
                }
                .prescription-footer hr { 
                    border: 1px solid #000; 
                    margin-top: 30px; 
                }
                @media print {
                    body { margin: 0; }
                    pre { background-color: white; border: 1px solid #000; }
                }
            </style>
        </head>
        <body>
            ${printContent}
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.onload = function() {
        printWindow.print();
        printWindow.onafterprint = function() {
            printWindow.close();
        };
    };
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const requiredFields = ['medications', 'dosage', 'instructions'];
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        let firstInvalidField = null;
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const value = field.value.trim();
            
            if (!value) {
                isValid = false;
                field.classList.add('is-invalid');
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            if (firstInvalidField) {
                firstInvalidField.focus();
            }
            alert('Please fill in all required fields.');
        }
    });
    
    // Remove validation styling on input
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
            }
        });
    });
});
</script>
{% endblock %}
